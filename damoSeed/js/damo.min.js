/*!
 * Damo JavaScript Library v2.0
 * http://www.oceanvirtuel.com/damo
 * Author Herve Le Cornec, hcl@oceanvirtuel.com
 * Copyright 2017 Herve Le Cornec
 * Released under the GPL license
 * http://www.gnu.org/licenses/gpl.html
 *
 * Requires jquery.js
 * Copyright 2005, 2016 jQuery Foundation, Inc. and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: Sat, 06 Sep 2017 01:11:54 +0200
 */
var damo={dm:{},fn:{},routing:{},directive:{},filter:{},method:{},config:{securityBreak:10,switchPageDelay:300,showHideDelay:200}};damo.method.twoWayDataBinding=function(){jQuery.each(["change"],function(e,t){jQuery.fn[t]=function(e,a){var o,r;return e&&(o=(o=(r=e.toString().replace(/\n/g,"###kk###")).replace(/^function *\(([^\)]+)\) *\{.*$/i,"$1"))!=r&&o.replace(/###kk###/g,"\n"),r="\ndamo.method.setSingleValue($(this));\n"+r.replace(/^function[^\{]+\{/i,"").replace(/\} *$/g,"").replace(/###kk###/g,"\n")+";\ndamoRefresh();",e=o?new Function(o,"e",r):new Function("e",r)),arguments.length>0?this.on(t,null,e,a):this.trigger(t)}}),$("input").change(function(){}),$("textarea").change(function(){}),$("select").change(function(){})},damo.method.trySearch=function(expr){var res;if(expr){try{res=eval("damo.dm."+expr),isNaN(res)}catch(e){}if(!res)try{0!==res&&(res=eval(expr))}catch(e){}return res}},damo.method.setSingleValue=function(el){var type,id,list,val,i,res;if(type=el.prop("type"),id=el.attr("damo-id"))if("checkbox"==type){val=el.attr("damo-id").replace(/^(.*)\.[^\.]+$/,"$1.checked");try{eval("damo.dm."+val+' = el.is(":checked")'),damo.method.SetDomValues()}catch(err){try{eval(val+' = el.is(":checked")'),damo.method.SetDomValues()}catch(e){}}}else if("radio"==type){if(val=el.attr("damo-id").replace(/^(.*)\.[^\.]+$/,"$1.checked"),list=damo.method.trySearch(el.attr("name"))){for(i=0;i<list.length;i++)list[i].checked=!1;damo.method.trySearch(val+"=true")}}else try{eval("damo.dm."+id+" = el.val()"),damo.method.SetDomValues()}catch(err){try{eval(id+" = el.val()"),damo.method.SetDomValues()}catch(e){}}},damo.method.getValue=function(e){var t,a;return t=$('[damo-id="'+e+'"]').prop("type"),"checkbox"==t?(a=e.replace(/^(.*)\.[^\.]+$/,"$1")+".checked",damo.method.trySearch(a)):"radio"==t?(a=e.replace(/^(.*)\.[^\.]+$/,"$1")+".checked",damo.method.trySearch(a)):damo.method.trySearch(e)},damo.method.addSlashes=function(e){return e.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\-/g,"\\-").replace(/\./g,"\\.")},damo.method.buildRouting=function(){var e,t;for(e in damo.routing)if("index.html"==damo.routing[e].template){t=damo.routing[e].url,e,window.location.href=window.location.href.replace(/#.*$/,"")+"#!"+e,damo.routing.current={name:e,url:t,oldUrl:t};break}for(e in damo.routing)"index.html"!=damo.routing[e].template&&$("body").append('<damo-page url="'+damo.routing[e].url+'" style="width:100%;padding:0;margin:0"></damo-page>');return!0},damoGo=function(page){var key,el,params=null,arr2,arr3,obj={},i,newHref=window.location.href.replace(/#.*$/,"")+"#!"+page,arr=page.split("?"),url=arr[0];if(url!=page)for(params=arr[1],arr2=params.split("&"),i=0;i<arr2.length;i++)arr3=arr2[i].split("="),obj[arr3[0]]=arr3[1];page=url,damo.routing.current={name:page,url:damo.routing[page].url,param:obj,oldUrl:damo.routing.current.url},damo.routing.current.url!=damo.routing.current.oldUrl&&$.when($("damo-page").slideUp(damo.config.switchPageDelay,function(){})).then(function(){if($('damo-page[url="'+page+'"]').html()){if(damo.routing[page].needLogin&&!damo.dm.logged)return setTimeout(function(){damoGo("home")},200),!1;window.location.href!=newHref&&(window.location.href=newHref)}else $.get(damo.routing[page].template,function(data){damo.routing[page].template=data,(el=$('damo-page[url="'+page+'"]')).html(data),damo.method.build(el),damo.routing.current={name:key,url:damo.routing[page].url,params:obj};try{eval(damo.routing[page].controller)}catch(e){}damo.method.setLang($('damo-page[url="'+page+'"]')),window.location.href!==newHref&&(window.location.href=newHref)});$('damo-page[url="'+page+'"]').slideDown(damo.config.switchPageDelay,function(){}),damoRefresh()})},damo.method.feedDirectives=function(){var e,t={};for(e in damo.directive)t[e]=new $.Deferred,damo.directive[e].html&&""!=damo.directive[e].html||damo.directive[e].templateUrl&&""!=damo.directive[e].templateUrl&&$.ajax({type:"GET",async:!1,url:damo.directive[e].templateUrl,success:function(a){damo.directive[e].html=a,t[e].resolve()},error:function(){console.log('error, "'+e+'" directive template not found')}});return t[e].promise()},damo.method.BuildDirectives=function(e){if($("[damo-seed]").length){var e=$("body");damo.method.feedDirectives().done(function(){for(var t,a,o,r,d,n,m,l=0;;){if(++l>damo.config.securityBreak)break;if(!(d=e.find("[damo-seed]")).length)break;for(i=0;i<d.length;i++)t=$(d[i]),(a=damo.directive[t.attr("damo-seed")])&&a.html&&(o=t.attr("damo-ref"),r=a.html,o&&(n=new RegExp("damo-ref","g"),r=a.html.replace(n,o)),t.replaceWith('<damo-seeding="'+t.attr("damo-seed")+'">'+r+"</damo-seeding>"),a.controller&&"function"==typeof(m=window[a.controller])&&(m(),damo.method.setTriggers()))}damo.method.SetDomValues(e)})}},damo.method.BuildSingleLoop=function(e){var t,a,o,r,d,i,n,m;if((r=e.attr("damo-loop"))&&(a=r.replace(/^ *([^ ]+) .*$/,"$1"),o=r.replace(/^.* ([^ ]+) *$/,"$1"),(d=damo.method.trySearch(o))&&(d.length||0===d.length))){i=e[0].outerHTML,r="";var l=0===d.length?1:d.length;for(j=0;j<l;j++)n=$(i).attr("damo-loop"),m=$(i).removeAttr("damo-loop"),tagName=m.prop("tagName").toLowerCase(),0==j&&m.attr("damo-looping-start",n),j==l-1&&m.attr("damo-looping-end",n),"option"==tagName&&(t=new RegExp(damo.method.addSlashes(a)+"(.?)","g"),m.attr("damo-opt-text",m.html().replace(t,o+"["+j+"]$1")),m.attr("damo-opt-val",m.val().replace(t,o+"["+j+"]$1"))),m.find('[damo-id^="'+a+'."]').each(function(){var e;e=new RegExp("^"+damo.method.addSlashes(a)+".","g"),$(this).attr("damo-id",$(this).attr("damo-id").replace(e,o+"["+j+"]."))}),m.find('[damo-if*="'+a+'."]').each(function(){var e;e=new RegExp(damo.method.addSlashes(a)+".","g"),$(this).attr("damo-if",$(this).attr("damo-if").replace(e,o+"["+j+"]."))}),m.attr("value")&&m.attr("value").split(".")[0]==a&&m.attr("value",m.attr("value").replace(t,o+"["+j+"].")),t=new RegExp("{{"+a+"(.[^}]+)?}}","g"),m.html(m.html().replace(t,"{{"+o+"["+j+"]$1}}")),m.find('[damo-loop*=" '+a+'"]').each(function(){$(this).attr("damo-loop",$(this).attr("damo-loop").replace(" "+a," "+o+"["+j+"]"))}),r+=m[0].outerHTML.replace(/\$index/gi,j)+"\n";e.replaceWith(r)}},damo.method.BuildLoops=function(e){if($("[damo-loop]").length){var t=0;if(!e)var e=$("body");for(;;){if(++t>damo.config.securityBreak)break;e.find("[damo-loop]").each(function(){damo.method.BuildSingleLoop($(this))})}}},damo.method.renewLoop=function(str){var item,listName,list;if(!str)return"";item=str.replace(/^ *([^ ]+) .*$/,"$1"),listName=str.replace(/^.* ([^ ]+) *$/,"$1");try{list=eval("damo.dm."+listName)}catch(e){return""}$('[damo-looping-start="'+str+'"]').each(function(){for(var e=$(this),t=0;!e.attr("damo-looping-end");)e=e.next(),t++;if(list.length!=t+1){if(0==list.length){if("none"==e.css("display"))return;for(;t>0;)prev=e.prev(),prev.attr("damo-looping-end",e.attr("damo-looping-end")),e.remove(),e=prev,t--;e.hide()}else if(list.length<t+1)for(;list.length!=t+1;)prev=e.prev(),prev.attr("damo-looping-end",e.attr("damo-looping-end")),e.remove(),e=prev,t--;else if(list.length>t+1)for(;list.length!=t+1;){var a=e.clone(!0,!0),o=a[0].outerHTML,r=new RegExp(damo.method.addSlashes(listName),"g");o=(o=o.replace(r,"###kk###")).replace(/\\n/g,"").replace(/_([0-9]+)\"/g,"_"+(t+1)+'"').replace(/\[([0-9]+)\]/g,"["+(t+1)+"]").replace(/\(([0-9]+)\)/g,"("+(t+1)+")")+"\n",r=new RegExp("###kk###","g"),o=o.replace(r,listName),a=$(o),e.after(a),newEl=e.next(),newEl.attr("damo-looping-end",e.attr("damo-looping-end")),e.removeAttr("damo-looping-end"),newEl.attr("damo-looping-start")&&newEl.removeAttr("damo-looping-start"),newEl.find("input").change(function(){}),newEl.find("textarea").change(function(){}),newEl.find("select").change(function(){}),newEl.show(),e=e.next(),t++}}else"none"==e.css("display")&&e.css("display","block")}),damo.method.setTriggers(),damo.method.SetDomValues()},damo.method.SetDomValues=function(e){var t,a,o,r,e,d,i;e||(e=$("body")),e.find('[value*="{{"]').each(function(){var e=damo.method.trySearch($(this).val().replace(/\{/g,"").replace(/\}/g,""));e&&$(this).val(e)}),e.find('[damo-trigger*="{{"]').each(function(){var e=new RegExp("^.*{{([^}]+)}}.*$","g"),t=($(this).attr("damo-trigger").match(e),$(this).attr("damo-trigger").replace(/^.*\{\{([^\}]+)\}\}.*$/,"$1")),a=damo.method.getValue(t);if(a){e=new RegExp("{{"+damo.method.addSlashes(t)+"}}");var o=$(this).attr("damo-trigger").replace(e,a);$(this).attr("damo-trigger",o)}}),e.find("[damo-id]").each(function(){t=$(this).attr("damo-id"),a=$(this).prop("tagName").toLowerCase(),r=damo.method.getValue(t),(d=$(this).attr("damo-filter"))&&"function"==typeof(i=damo.filter[d])&&(r=i(r));try{switch(a){case"input":switch(o=$(this).attr("type").toLowerCase()){case"checkbox":case"radio":$(this).prop("checked",r);break;default:$(this).val(r)}break;case"select":$(this).val(String(r));break;case"textarea":$(this).val(r);break;default:$(this).html(r)}}catch(e){}}),e.find("[damo-data]").each(function(){t=$(this).attr("damo-data").replace(/\{/g,"").replace(/\}/g,"");var e=damo.method.trySearch(t);e&&$(this).attr("damo-data",e)}),$("option").each(function(){var e,t,a,o,r,d;if(d=$(this).attr("damo-opt-text"),t=damo.method.getValue($(this).attr("damo-opt-val")))for($(this).attr("value",t),$(this).html(d),a=new RegExp(".*{{([^}]+)}}.*"),e=0;;){if(++e>damo.config.securityBreak)break;if(r=$(this).html().replace(a,"$1"),$(this).html()==r)break;o=new RegExp("{{"+damo.method.addSlashes(r)+"}}","g"),t=damo.method.getValue(r),$(this).html($(this).html().replace(o,t))}})},damo.method.setConditions=function(){$("[damo-if]").each(function(){var item,res,reg,a,op,b,not="";(item=$(this).attr("damo-if")).match(/^!/)&&(item=item.replace(/!/,""),not="!");try{res=eval(not+item)}catch(err){try{res=eval(not+"damo.dm."+item)}catch(err){reg=new RegExp(/^([^=!<>]+) *([=!<>]+) *([^=!<>]+)$/),a=item.replace(reg,"$1"),op=item.replace(reg,"$2"),b=item.replace(reg,"$2");try{res=eval("damo.dm."+a+op+"damo.dm."+b)}catch(err){try{res=eval("damo.dm."+a+op+b)}catch(err){try{res=eval(a+op+"damo.dm."+b)}catch(e){}}}}}$(this).attr("display")&&"none"!=$(this).attr("display")&&$(this).data("initDisplay",$(this).attr("display")),res?($(this).show(damo.config.showHideDelay),$(this).data("initDisplay")&&$(this).css("display",$(this).data("initDisplay"))):$(this).hide(damo.config.showHideDelay)})},damo.method.setTriggers=function(){$("[damo-trigger]").each(function(){var fn;fn=$(this).attr("damo-trigger"),$(this).off("mousedown"),$(this).off("click"),$(this).mousedown(function(){try{eval("damo.fn."+fn+"()")}catch(err){try{eval(fn+"()")}catch(err){try{eval("damo."+fn+"()")}catch(e){}}}})})},damo.method.getLang=function(e){e||(e=$("body"));var t=navigator.language;$.get("lang/"+t+".json",function(e){damo.dm.lang=e}).done(function(){damo.method.setLang(e)}).fail(function(){console.log('Language is "'+t+'". Corresponding JSON was not found in /lang directory.'),damo.dm.lang={}})},damo.method.setLang=function(e){e.find("[damo-lang]").each(function(){$(this).html()||$(this).html(damo.dm.lang[$(this).attr("damo-lang")])});for(var t=["placeholder","value"],a=0;a<t.length;a++)e.find("["+t[a]+'^="{{lang"]').each(function(){if(!$(this).html()){var e=$(this).attr(t[a]).replace(/[\{\}]/g,"").replace(/lang\./,"");$(this).attr(t[a],damo.dm.lang[e])}})},damo.method.build=function(e){damo.method.BuildDirectives(),damo.method.BuildLoops(e),e&&(fn=window[damo.routing[damo.routing.current.name].controller],"function"==typeof fn&&fn()),setTimeout(function(){damo.method.setConditions(),damo.method.setTriggers(),damo.method.twoWayDataBinding(),damo.method.SetDomValues(e),damo.method.getLang(),damoRefresh()},damo.config.switchPageDelay)},$(document).ready(function(){$.get("data/datamodel.json",function(e){damo.dm=e}).done(function(){var e;damo.method.buildRouting(),e=$('damo-page[url="'+damo.routing.current.url+'"]'),damo.method.build(e)}).fail(function(e){damo.routing.home||(console.log("No default damo.routing.home has been found, creating one"),damo.routing={home:{url:"/home",template:"index.html",controller:"controller_home"}},damo.method.buildRouting(),damo.routing.current={name:"home",url:damo.routing.home.url,oldUrl:damo.routing.home.url}),damo.method.buildRouting(),scope=$('damo-page[url="'+damo.routing.current.url+'"]'),damo.method.build(scope)}),$(window).on("hashchange",function(e){setTimeout(function(){var e=window.location.hash.replace(/^#!/,"");damoGo(e)},300)})}),damoRefresh=function(){$("[damo-loop]").length&&(damo.method.BuildLoops(),damo.method.SetDomValues(),damo.method.setConditions(),damo.method.setTriggers()),$("[damo-seed]").length&&(damo.method.BuildDirectives(),damo.method.SetDomValues(),fn=window[damo.routing[damo.routing.current.name].controller],"function"==typeof fn&&fn(),damo.method.setConditions(),damo.method.setTriggers());for(var e=0;e<2;e++)$("[damo-looping-start]").each(function(){damo.method.renewLoop($(this).attr("damo-looping-start"))});damo.method.SetDomValues(),damo.method.setConditions()},damoExport=function(){var e={id:"app",title:"Extract",description:"Data Model",date:(new Date).toUTCString(),dataModel:damo.dm},t=document.createElement("a");t.href="data:attachment/text,"+encodeURI(JSON.stringify(e,null,4)),t.target="_blank",t.download="export.json",document.body.appendChild(t),t.click(),document.body.removeChild(t)};
