/*!
 * Damo JavaScript Library v0.0.1
 * http://www.oceanvirtuel.com/damo
 * Author Herve Le Cornec, hcl@oceanvirtuel.com
 * Copyright 2016 Herve Le Cornec
 * Released under the GPL license
 * http://www.gnu.org/licenses/gpl.html
 *
 * Requires jquery.js
 * Copyright 2005, 2016 jQuery Foundation, Inc. and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2016-04-07T18:48Z
 */
var $scp={$route:{last:null,current:null,next:null},$routing:[],$filter:{},$directive:{},$config:{damperDelay:10,sliderDelay:200,loaderDelay:100,iterationBreak:10,DirectiveDepth:3},$dm:{}};!function(){jQuery.each(["change"],function(e,t){jQuery.fn[t]=function(e,r){return e&&(e=new Function(e.toString().replace(/\}$/," });").replace(/^function[^{]+{/i,"function$1{$.when($scp.$setObjProperty($scp.$dm,$(this).attr('id'),$(this).val())).done(function(){").replace(/^function[^{]+{/i,""))),arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),$scp.$setObjProperty=function(obj,path,newValue){def=$.Deferred();var key,newPath,res;if(!$.isArray(newValue)){if(newValue=String(newValue),!obj||!path||!newValue)return def.resolve(),def.promise();var elem=$('[id="'+path+'"]');if(elem.prop("tagName").match(/textarea/i)&&(newValue=newValue.replace(/\n/,"\\n")),elem.attr("type")&&elem.attr("type").match(/checkbox/)){res=elem.is(":checked")?"true":"false";try{oldValue=eval("$scp.$dm."+path),eval("$scp.$dm."+path+"="+res+";")}catch(err){try{oldValue=eval("$scp."+path),eval("$scp."+path+"="+res+";")}catch(err){}}if(String(oldValue)!=String(newValue))return $scp.$updateView(),def.resolve(),def.promise()}else if("true"==newValue||"false"==newValue||"null"==newValue||newValue.match(/^[0-9\.]+$/)){newValue.match(/^[0-9\.]+$/)?newValue=parseFloat(newValue):newValue.match(/^[0-9]+$/)&&(newValue=parseInt(newValue));try{if(oldValue=eval("$scp."+path),res=eval("$scp."+path+"="+newValue+";"),String(oldValue)!=String(newValue))return $scp.$updateView(),def.resolve(),def.promise()}catch(err){try{if(oldValue=eval("$scp.$dm."+path),eval("$scp.$dm."+path+"="+newValue+";"),String(oldValue)!=String(newValue))return $scp.$updateView(),def.resolve(),def.promise()}catch(err){}}}else try{if(oldValue=eval("$scp."+path),eval("$scp."+path+'="'+newValue+'";'),String(oldValue)!=String(newValue))return $scp.$updateView(),def.resolve(),def.promise()}catch(err){try{if(oldValue=eval("$scp.$dm."+path),eval("$scp.$dm."+path+'="'+newValue+'";'),String(oldValue)!=String(newValue))return $scp.$updateView(),def.resolve(),def.promise()}catch(err){}}}},$scp.$buildDirectives=function(){def_directive=$.Deferred();var e,t,r=$("body");for(e in $scp.$directive)break;e||def_directive.resolve();for(e in $scp.$directive)items=r.find(e),items.length&&$.get($scp.$directive[e].template,function(r){for(i=0;i<items.length;i++)base=r,t=$(items[i]).attr("damo-seed")+".",reg=new RegExp($scp.$directive[e].seed+".","g"),base=base.replace(reg,t),$(items[i]).replaceWith(base)});return setTimeout(function(){def_directive.resolve()},$scp.$config.damperDelay),def_directive.promise()},$scp.$updateLoops=function(){var e,t,r,a,o,n,i,l,s,c;for(def_updateloop=$.Deferred(),r=$("body"),t=0;t<$scp.$config.DirectiveDepth;t++){var p=!1;r.find("[damo-startloop]").each(function(){if($(this).is(p))return p=$(this),!0;if(p=$(this),len=parseInt($(this).attr("damo-length")),tag=$(this).prop("tagName").toLowerCase(),elem=$(this),o=$(this).attr("damo-startloop"),i=o.replace(/^ *([^ ]+) *in.*$/,"$1"),n=o.replace(/^.*in *([^ ]+) *$/,"$1"),a=$(this).prop("outerHTML"),l=$scp.$seekData(!1,n),l?diff=l.length-len:diff=0,diff){if("option"==tag)if(sel=elem.next(),elem2=sel.children().first(),diff>0){for(0===len&&(len=1,elem2.show()),e=0;e<len-1;e++)elem2=elem2.next();for(e=0;e<diff;e++)c=new RegExp($scp.$rxFormat(i+"."),"g"),s=a.replace(c,n+"["+(len+e)+"]."),s=s.replace(/\[\[/g,"{{").replace(/\]\]/g,"}}"),elem2.after(s),elem2=elem2.next(),elem2.removeAttr("damo-startloop").removeAttr("damo-length").show()}else{for(diff=-diff,sel=elem.next(),elem2=sel.children().first(),e=0;e<len-1;e++)elem2=elem2.next();for(e=0;e<diff;e++)inter=elem2.prev(),elem2.remove(),elem2=inter}else if(diff>0){for(e=0;e<len;e++)elem=elem.next();for(e=0;e<diff;e++)c=new RegExp($scp.$rxFormat(i+"."),"g"),s=a.replace(c,n+"["+(len+e)+"]."),s=s.replace(/\[\[/g,"{{").replace(/\]\]/g,"}}"),elem.after(s),elem=elem.next(),elem.removeAttr("damo-startloop").removeAttr("damo-length").show()}else{for(diff=-diff,elem=$(this),e=0;e<len;e++)elem=elem.next();for(e=0;e<diff;e++)inter=elem.prev(),elem.remove(),elem=inter}$(this).attr("damo-length",l.length)}})}return def_updateloop.resolve(),def_updateloop.promise()},$scp.$seekData=function(filter,param){if(val=!1,filter)try{if(val=eval("$scp.$filter."+filter+"($scp."+param+")"),!val||"undefined"===val)try{val=eval("$scp.$filter."+filter+"($scp.$dm."+param+")")}catch(err){}}catch(err){try{val=eval("$scp.$filter."+filter+"($scp.$dm."+param+")")}catch(err){}}else try{if(val=eval("$scp."+param),!val||"undefined"===val)try{val=eval("$scp.$dm."+param)}catch(err){}}catch(err){try{val=eval("$scp.$dm."+param)}catch(err){}}return val},$scp.$buildDmValues=function(){return def=$.Deferred(),$.when($scp.$setDmValues(!0)).done(function(){def.resolve()}),def.promise()},$scp.$setDmValues=function(e){return def=$.Deferred(),scope=$("body"),$("body").find("option").filter(':contains("{{")').length&&$("body").find("option").filter(':contains("{{")').each(function(){text=$(this).text().replace(/\n/g,""),reg=new RegExp("^.*{{ *([^}{ ]+) *}}.*$"),res=text.match(reg),res&&(val=$scp.$seekData(!1,res[1]),reg=new RegExp($scp.$rxFormat("{{ *"+res[1]+" *}}"),"g"),$(this).text($(this).text().replace(reg,val)),$(this).val(val))}),scope.find("[id]").each(function(){tag=$(this).prop("tagName").toLowerCase(),type=$(this).prop("type")?$(this).prop("type").toLowerCase():!1,filter=$(this).attr("damo-filter"),val=$scp.$seekData(filter,$(this).attr("id")),"object"!=typeof val&&(val="undefined"==val?"":String(val),"select"==tag?e?($(this).change(function(){}),"null"!=String($(this).val())?$(this).val(val):$(this).val($(this).find("option").first().val())):"null"!=String($(this).val())?$(this).val(val):$(this).val($(this).find("option").first().val()):"input"==tag&&"radio"==type?($(this).filter('[value="'+val+'"]').attr("checked",!0),e&&$(this).change(function(){})):"input"==tag&&"checkbox"==type?scope.find('input[id="'+$(this).attr("id")+'"][type="checkbox"]').each(function(){"true"==val||"0"==val?$(this).attr("checked",!0):$(this).attr("checked",!1),e&&$(this).change(function(){})}):"input"==tag||"textarea"==tag?($(this).val(val),e&&$(this).change(function(){})):$(this).html(val))}).promise().done(function(){def.resolve()}),def.promise()},$scp.$setConditions=function(){var res,newcond,newconddm,def;return def=$.Deferred(),scope=$("body"),scope.find("[damo-if]").each(function(){var cond=$(this).attr("damo-if");reg=new RegExp(".*([<>&|!= ]).*","g");var a=cond.replace(/[!&<>=\|]/g," ").replace(/ +/g," ");arr=a.split(" "),newcond=cond,newconddm=cond;for(var i=0;i<arr.length;i++)""!==arr[i]&&(reg=new RegExp(arr[i].replace(/\[/g,"\\[").replace(/\]/g,"\\]")),newcond=newcond.replace(reg,"$scp."+arr[i]),newconddm=newconddm.replace(reg,"$scp.$dm."+arr[i]));res=!1;try{res=eval(newcond)}catch(err){try{res=eval(newconddm)}catch(err){}}res?$(this).slideDown($scp.$config.sliderDelay):$(this).slideUp($scp.$config.sliderDelay)}).promise().done(function(){def.resolve()}),def.promise()},$scp.$buildForms=function(){var key;return def=$.Deferred(),scope=$("body"),scope.find("[damo-submitform]").each(function(){$(this).click(function(){for(key in $scp.$dm)break;var arr=[];$('[damo-form="'+$(this).attr("damo-submitform")+'"]').find("[id]:visible").each(function(){arr.push({item:$(this).attr("id"),value:$(this).val()})}),$scp.$submitData=arr;try{eval("$scp."+$(this).attr("damo-submitform")+"()")}catch(err){}})}).promise().done(function(){scope.find("[damo-trigger]").each(function(){$(this).click(function(){try{eval("$scp."+$(this).attr("damo-trigger")+"()")}catch(err){}})}).promise().done(function(){def.resolve()})}),def.promise()},$scp.$Damo=function(e,t){return def_Damo=new $.Deferred,$(document).ready(function(){e&&("string"==typeof e?$.get(e,function(e){return $scp.$dm=e,!0}):$scp.$dm=e,setTimeout(function(){var e,r,a;if($scp.$afterLoading=t?t:function(){},$scp.$routing.length){for(r=!1,e=0;e<$scp.$routing.length;e++)if("index.html"===$scp.$routing[e].template){r=!0,0!==e&&(a=$scp.$routing[e],$scp.$routing.splice(e,1),$scp.$routing.unshift(a),$scp.$routing.sort());break}r||$scp.$routing.unshift({url:"/",template:"index.html"})}else page=window.location.href.replace(/.*\/([^\/]+)(\?.*)?/,"$1"),$scp.$routing.push({url:"/",template:page});$scp.$route.current=$scp.$routing[0].url,$('[damo-damo="'+$scp.$route.current+'"]').attr("damo-damo","damoPage_"+$scp.$route.current),$scp.$concatenePages().done(function(){$scp.$buildDirectives().done(function(){$scp.$buildLoops().done(function(){$scp.$buildDmValues(!0).done(function(){$scp.$setConditions().done(function(){$scp.$buildForms().done(function(){setTimeout(function(){$scp.$afterLoading(),def_Damo.resolve()},$scp.$config.damperDelay)})})})})})})},$scp.$config.loaderDelay))}),def_Damo.promise()},$scp.$concatenePages=function(){var e;for(def0_concat=new $.Deferred,def_concat=[],e=0;e<$scp.$routing.length-1;e++)def_concat[e]=new $.Deferred,$("body").append('<div damo-damo="damoPage_'+$scp.$routing[e+1].url+'"></div>'),$('[damo-damo="damoPage_'+$scp.$routing[e+1].url+'"]').css("display","none"),$('[damo-damo="damoPage_'+$scp.$routing[e+1].url+'"]').load($scp.$routing[e+1].template).promise().done(function(){def_concat[e].resolve()});return setTimeout(function(){def0_concat.resolve()},$scp.$config.damperDelay),def0_concat.promise()},$scp.$buildLoops=function(){def_loop=$.Deferred();$("body");if($("[damo-loop]").length)for(k=0;$("[damo-loop]").length&&(N=$("[damo-loop]").length,n=1,$("[damo-loop]").each(function(){if(loop=$(this).attr("damo-loop"),listName=loop.replace(/.*in *([^ ]+) *$/,"$1"),varName=loop.replace(/^ *([^ ]+) *in.*$/,"$1"),list=$scp.$seekData(!1,listName),tag=$(this).prop("tagName"),template=$(this).prop("outerHTML"),template2=template.replace(/damo\-loop/,"damo-startloop").replace(/\{/g,"[").replace(/\}/g,"]"),list){for(tag.match(/option/i)?($(this).parent().before(template2),$(this).parent().prev().css("display","none").attr("damo-length",list.length)):($(this).before(template2),$(this).prev().css("display","none").attr("damo-length",list.length)),base=$(this).prop("outerHTML").replace(/\n/g,"##&#gh491#@@"),base=base.replace(/damo\-loop *= *\"[^\"]+\"/,""),total="",i=0;i<list.length;i++)str=base,reg=new RegExp($scp.$rxFormat(varName+"."),"g"),str=str.replace(reg,listName+"["+i+"]."),total+=str;total&&$(this).replaceWith(total.replace(/##&#gh491#@@/g,"\n"))}else tag.match(/option/i)?($(this).parent().before(template2),$(this).parent().prev().css("display","none").attr("damo-length",0)):($(this).before(template2),$(this).prev().css("display","none").attr("damo-length",0)),$(this).remove();$(this).remove(),n++,n>N&&def_loop.resolve()}),k++,!(k>$scp.$config.iterationBreak)););else def_loop.resolve();return def_loop.promise()},$scp.$updateView=function(){var e=$.Deferred();return setTimeout(function(){$.when($scp.$updateLoops()).done($scp.$setDmValues()).done($scp.$setConditions()).done(function(){e.resolve()})},$scp.$config.timeoutShort),e.promise()},$scp.$ArrayUnique=function(e,t,r){return r.indexOf(e)===t},$scp.$rxFormat=function(e){return e?e.replace(/\"/g,'\\"').replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\-/g,"\\-").replace(/\|/g,"\\|").replace(/\./g,"\\.").replace(/\{/g,"\\{").replace(/\}/g,"\\}"):e}}(),$(document).ready(function(){$(window).on("popstate",function(e){var t=String(window.location.href).replace(/.*#(.*)$/,"$1");$('[damo-damo="damoPage_'+t+'"]').length&&($scp.$route.last=$scp.$route.current,$scp.$route.current=t,$('[damo-damo="damoPage_'+$scp.$route.last+'"]').hide(),$scp.$updateView(),$('[damo-damo="damoPage_'+$scp.$route.current+'"]').show())}),$scp.$changePage=function(e){var t=window.location.href.replace(/#.*$/,"");for(i=0;i<$scp.$routing.length;i++)if($scp.$routing[i].url===e){$('[damo-damo="damoPage_'+e+'"]').length?(window.location.href=t+"#"+$scp.$routing[i].url,setTimeout(function(){$scp.$updateView()},$scp.$config.damperDelay),$('[damo-damo="damoPage_'+$scp.$route.last+'"]').hide(),$('[damo-damo="damoPage_'+$scp.$route.current+'"]').show()):(window.location.href=t+"#"+$scp.$routing[i].url,$("body").append('<div damo-damo="damoPage_'+e+'"></div>'),$scp.$route.last=$scp.$route.current,$scp.$route.current=$scp.$routing[i].url,$('[damo-damo="damoPage_'+$scp.$route.last+'"]').hide(),$('[damo-damo="damoPage_'+$scp.$route.current+'"]').load($scp.$routing[i].template),$('[damo-damo="damoPage_'+$scp.$route.current+'"]').show());break}}});
