/*!
 * Damo JavaScript Library v0.0.1
 * http://www.oceanvirtuel.com/damo
 * Author Herve Le Cornec, hcl@oceanvirtuel.com
 * Copyright 2016 Herve Le Cornec
 * Released under the GPL license
 * http://www.gnu.org/licenses/gpl.html
 *
 * Requires jquery.js
 * Copyright 2005, 2016 jQuery Foundation, Inc. and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: Sat, 30 Apr 2017 01:11:54 +0200
 */
var damo={dm:{},fn:{},routing:{},directive:{},filter:{},method:{},config:{securityBreak:10,switchPageDelay:300,showHideDelay:200}};damo.method.twoWayDataBinding=function(){jQuery.each(["change"],function(a,b){jQuery.fn[b]=function(a,c){var d,e,f;return a&&(e=a.toString().replace(/\n/g,"###kk###"),d=e.replace(/^function *\(([^\)]+)\) *\{.*$/i,"$1"),d=d!=e&&d.replace(/###kk###/g,"\n"),f=e.replace(/^function[^\{]+\{/i,"").replace(/\} *$/g,"").replace(/###kk###/g,"\n"),e="\ndamo.method.setSingleValue($(this));\n"+f+";\ndamoRefresh();",a=d?new Function(d,"e",e):new Function("e",e)),arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),$("input").change(function(){}),$("textarea").change(function(){}),$("select").change(function(){})},damo.method.trySearch=function(expr){var res;if(expr){try{res=eval("damo.dm."+expr),isNaN(res)}catch(a){}if(!res)try{0!==res&&(res=eval(expr))}catch(a){}return res}},damo.method.setSingleValue=function(el){var type,id,list,val,i,res;if(type=el.prop("type"),id=el.attr("damo-id"))if("checkbox"==type){val=el.attr("damo-id").replace(/^(.*)\.[^\.]+$/,"$1.checked");try{eval("damo.dm."+val+' = el.is(":checked")'),damo.method.SetDomValues()}catch(err){try{eval(val+' = el.is(":checked")'),damo.method.SetDomValues()}catch(a){}}}else if("radio"==type){if(val=el.attr("damo-id").replace(/^(.*)\.[^\.]+$/,"$1.checked"),list=damo.method.trySearch(el.attr("name"))){for(i=0;i<list.length;i++)list[i].checked=!1;damo.method.trySearch(val+"=true")}}else try{eval("damo.dm."+id+" = el.val()"),damo.method.SetDomValues()}catch(err){try{eval(id+" = el.val()"),damo.method.SetDomValues()}catch(a){}}},damo.method.getValue=function(a){var b,c;return b=$('[damo-id="'+a+'"]').prop("type"),"checkbox"==b?(c=a.replace(/^(.*)\.[^\.]+$/,"$1")+".checked",damo.method.trySearch(c)):"radio"==b?(c=a.replace(/^(.*)\.[^\.]+$/,"$1")+".checked",damo.method.trySearch(c)):damo.method.trySearch(a)},damo.method.addSlashes=function(a){return a.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\-/g,"\\-").replace(/\./g,"\\.")},damo.method.buildRouting=function(){var a,b;for(a in damo.routing)if("index.html"==damo.routing[a].template){b=damo.routing[a].url,a,window.location.href=window.location.href.replace(/#.*$/,"")+"#!"+a,damo.routing.current={name:a,url:b,oldUrl:b};break}for(a in damo.routing)"index.html"!=damo.routing[a].template&&$("body").append('<damo-page url="'+damo.routing[a].url+'" style="width:100%;padding:0;margin:0"></damo-page>');return!0},damoGo=function(page){var key,el,params=null,arr2,arr3,obj={},i,newHref=window.location.href.replace(/#.*$/,"")+"#!"+page,arr=page.split("?"),url=arr[0];if(url!=page)for(params=arr[1],arr2=params.split("&"),i=0;i<arr2.length;i++)arr3=arr2[i].split("="),obj[arr3[0]]=arr3[1];page=url,damo.routing.current={name:page,url:damo.routing[page].url,param:obj,oldUrl:damo.routing.current.url},damo.routing.current.url!=damo.routing.current.oldUrl&&$.when($("damo-page").slideUp(damo.config.switchPageDelay,function(){})).then(function(){if($('damo-page[url="'+page+'"]').html()){if(damo.routing[page].needLogin&&!damo.dm.logged)return setTimeout(function(){damoGo("home")},200),!1;window.location.href!=newHref&&(window.location.href=newHref)}else $.get(damo.routing[page].template,function(data){damo.routing[page].template=data,el=$('damo-page[url="'+page+'"]'),el.html(data),damo.method.build(el),damo.routing.current={name:key,url:damo.routing[page].url,params:obj};try{eval(damo.routing[page].controller)}catch(a){}damo.method.setLang($('damo-page[url="'+page+'"]')),window.location.href!==newHref&&(window.location.href=newHref)});$('damo-page[url="'+page+'"]').slideDown(damo.config.switchPageDelay,function(){}),damoRefresh()})},damo.method.feedDirectives=function(){var b,a={};for(b in damo.directive)a[b]=new $.Deferred,damo.directive[b].html&&""!=damo.directive[b].html||damo.directive[b].templateUrl&&""!=damo.directive[b].templateUrl&&$.ajax({type:"GET",async:!1,url:damo.directive[b].templateUrl,success:function(c){damo.directive[b].html=c,a[b].resolve()},error:function(){console.log('error, "'+b+'" directive template not found')}});return a[b].promise()},damo.method.BuildDirectives=function(a){if($("[damo-seed]").length){var a=$("body");damo.method.feedDirectives().done(function(){for(var c,d,e,f,g,h,j,b=0;;){if(++b>damo.config.securityBreak)break;if(g=a.find("[damo-seed]"),!g.length)break;for(i=0;i<g.length;i++)c=$(g[i]),(d=damo.directive[c.attr("damo-seed")])&&d.html&&(e=c.attr("damo-ref"),f=d.html,e&&(h=new RegExp("damo-ref","g"),f=d.html.replace(h,e)),c.replaceWith('<damo-seeding="'+c.attr("damo-seed")+'">'+f+"</damo-seeding>"),d.controller&&"function"==typeof(j=window[d.controller])&&(j(),damo.method.setTriggers()))}damo.method.SetDomValues(a)})}},damo.method.BuildSingleLoop=function(a){var b,c,d,e,f,g,h,i,k;if((e=a.attr("damo-loop"))&&(c=e.replace(/^ *([^ ]+) .*$/,"$1"),d=e.replace(/^.* ([^ ]+) *$/,"$1"),(f=damo.method.trySearch(d))&&(f.length||0===f.length))){g=a[0].outerHTML,e="";var l=0===f.length?1:f.length;for(j=0;j<l;j++)h=$(g).attr("damo-loop"),i=$(g).removeAttr("damo-loop"),tagName=i.prop("tagName").toLowerCase(),0==j&&i.attr("damo-looping-start",h),j==l-1&&i.attr("damo-looping-end",h),"option"==tagName&&(b=new RegExp(damo.method.addSlashes(c)+"(.?)","g"),i.attr("damo-opt-text",i.html().replace(b,d+"["+j+"]$1")),i.attr("damo-opt-val",i.val().replace(b,d+"["+j+"]$1"))),i.find('[damo-id^="'+c+'."]').each(function(){var a;a=new RegExp("^"+damo.method.addSlashes(c)+".","g"),$(this).attr("damo-id",$(this).attr("damo-id").replace(a,d+"["+j+"]."))}),i.find('[damo-if*="'+c+'."]').each(function(){var a;a=new RegExp(damo.method.addSlashes(c)+".","g"),$(this).attr("damo-if",$(this).attr("damo-if").replace(a,d+"["+j+"]."))}),i.attr("value")&&(k=i.attr("value").split("."),k[0]==c&&i.attr("value",i.attr("value").replace(b,d+"["+j+"]."))),b=new RegExp("{{"+c+"(.[^}]+)?}}","g"),i.html(i.html().replace(b,"{{"+d+"["+j+"]$1}}")),i.find('[damo-loop*=" '+c+'"]').each(function(){$(this).attr("damo-loop",$(this).attr("damo-loop").replace(" "+c," "+d+"["+j+"]"))}),e+=i[0].outerHTML.replace(/\$index/gi,j)+"\n";a.replaceWith(e)}},damo.method.BuildLoops=function(a){if($("[damo-loop]").length){var b=0;if(!a)var a=$("body");for(;;){if(++b>damo.config.securityBreak)break;a.find("[damo-loop]").each(function(){damo.method.BuildSingleLoop($(this))})}}},damo.method.renewLoop=function(str){var item,listName,list;if(!str)return"";item=str.replace(/^ *([^ ]+) .*$/,"$1"),listName=str.replace(/^.* ([^ ]+) *$/,"$1");try{list=eval("damo.dm."+listName)}catch(a){return""}$('[damo-looping-start="'+str+'"]').each(function(){for(var a=$(this),b=0;!a.attr("damo-looping-end");)a=a.next(),b++;if(list.length==b+1)return void("none"==a.css("display")&&a.css("display","block"));if(0==list.length){if("none"==a.css("display"))return;for(;b>0;)prev=a.prev(),prev.attr("damo-looping-end",a.attr("damo-looping-end")),a.remove(),a=prev,b--;a.hide()}else if(list.length<b+1)for(;list.length!=b+1;)prev=a.prev(),prev.attr("damo-looping-end",a.attr("damo-looping-end")),a.remove(),a=prev,b--;else if(list.length>b+1)for(;list.length!=b+1;){var c=a.clone(!0,!0),d=c[0].outerHTML;d=d.replace(/\\n/g,"").replace(/_([0-9]+)\"/g,"_"+(b+1)+'"').replace(/\[([0-9]+)\]/g,"["+(b+1)+"]").replace(/\(([0-9]+)\)/g,"("+(b+1)+")")+"\n",c=$(d),a.after(c),newEl=a.next(),newEl.attr("damo-looping-end",a.attr("damo-looping-end")),a.removeAttr("damo-looping-end"),newEl.attr("damo-looping-start")&&newEl.removeAttr("damo-looping-start"),newEl.show(),a=a.next(),b++}}),damo.method.setTriggers(),damo.method.SetDomValues()},damo.method.SetDomValues=function(a){var b,c,d,e,a,f,g;a||(a=$("body")),a.find('[value*="{{"]').each(function(){var a=damo.method.trySearch($(this).val().replace(/\{/g,"").replace(/\}/g,""));a&&$(this).val(a)}),a.find('[damo-trigger*="{{"]').each(function(){var a=new RegExp("^.*{{([^}]+)}}.*$","g"),c=($(this).attr("damo-trigger").match(a),$(this).attr("damo-trigger").replace(/^.*\{\{([^\}]+)\}\}.*$/,"$1")),d=damo.method.getValue(c);if(d){a=new RegExp("{{"+damo.method.addSlashes(c)+"}}");var e=$(this).attr("damo-trigger").replace(a,d);$(this).attr("damo-trigger",e)}}),a.find("[damo-id]").each(function(){b=$(this).attr("damo-id"),c=$(this).prop("tagName").toLowerCase(),e=damo.method.getValue(b),(f=$(this).attr("damo-filter"))&&"function"==typeof(g=damo.filter[f])&&(e=g(e));try{switch(c){case"input":switch(d=$(this).attr("type").toLowerCase()){case"checkbox":case"radio":$(this).prop("checked",e);break;default:$(this).val(e)}break;case"select":$(this).val(String(e));break;case"textarea":$(this).val(e);break;default:$(this).html(e)}}catch(a){}}),a.find("[damo-data]").each(function(){b=$(this).attr("damo-data").replace(/\{/g,"").replace(/\}/g,"");var a=damo.method.trySearch(b);a&&$(this).attr("damo-data",a)}),$("option").each(function(){var a,b,c,d,e,f;if(f=$(this).attr("damo-opt-text"),b=damo.method.getValue($(this).attr("damo-opt-val")))for($(this).attr("value",b),$(this).html(f),c=new RegExp(".*{{([^}]+)}}.*"),a=0;;){if(++a>damo.config.securityBreak)break;if(e=$(this).html().replace(c,"$1"),$(this).html()==e)break;d=new RegExp("{{"+damo.method.addSlashes(e)+"}}","g"),b=damo.method.getValue(e),$(this).html($(this).html().replace(d,b))}})},damo.method.setConditions=function(){$("[damo-if]").each(function(){var item,res,reg,a,op,b,not="";item=$(this).attr("damo-if"),item.match(/^!/)&&(item=item.replace(/!/,""),not="!");try{res=eval(not+item)}catch(err){try{res=eval(not+"damo.dm."+item)}catch(err){reg=new RegExp(/^([^=!<>]+) *([=!<>]+) *([^=!<>]+)$/),a=item.replace(reg,"$1"),op=item.replace(reg,"$2"),b=item.replace(reg,"$2");try{res=eval("damo.dm."+a+op+"damo.dm."+b)}catch(err){try{res=eval("damo.dm."+a+op+b)}catch(err){try{res=eval(a+op+"damo.dm."+b)}catch(a){}}}}}$(this).attr("display")&&"none"!=$(this).attr("display")&&$(this).data("initDisplay",$(this).attr("display")),res?($(this).show(damo.config.showHideDelay),$(this).data("initDisplay")&&$(this).css("display",$(this).data("initDisplay"))):$(this).hide(damo.config.showHideDelay)})},damo.method.setTriggers=function(){$("[damo-trigger]").each(function(){var fn;fn=$(this).attr("damo-trigger"),$(this).off("mousedown"),$(this).off("click"),$(this).mousedown(function(){try{eval("damo.fn."+fn+"()")}catch(err){try{eval(fn+"()")}catch(err){try{eval("damo."+fn+"()")}catch(a){}}}})})},damo.method.getLang=function(a){a||(a=$("body"));var b=navigator.language;$.get("lang/"+b+".json",function(a){damo.dm.lang=a}).done(function(){damo.method.setLang(a)}).fail(function(){console.log('Language is "'+b+'". Corresponding JSON was not found in /lang directory.'),damo.dm.lang={}})},damo.method.setLang=function(a){a.find("[damo-lang]").each(function(){$(this).html()||$(this).html(damo.dm.lang[$(this).attr("damo-lang")])});for(var b=["placeholder","value"],c=0;c<b.length;c++)a.find("["+b[c]+'^="{{lang"]').each(function(){if(!$(this).html()){var a=$(this).attr(b[c]),d=a.replace(/[\{\}]/g,"").replace(/lang\./,"");$(this).attr(b[c],damo.dm.lang[d])}})},damo.method.build=function(a){damo.method.BuildDirectives(),damo.method.BuildLoops(a),a&&(fn=window[damo.routing[damo.routing.current.name].controller],"function"==typeof fn&&fn()),setTimeout(function(){damo.method.setConditions(),damo.method.setTriggers(),damo.method.twoWayDataBinding(),damo.method.SetDomValues(a),damo.method.getLang(),damoRefresh()},damo.config.switchPageDelay)},$(document).ready(function(){$.get("data/datamodel.json",function(a){damo.dm=a}).done(function(){var a;damo.method.buildRouting(),a=$('damo-page[url="'+damo.routing.current.url+'"]'),damo.method.build(a)}).fail(function(a){damo.routing.home||(console.log("No default damo.routing.home has been found, creating one"),damo.routing={home:{url:"/home",template:"index.html",controller:"controller_home"}},damo.method.buildRouting(),damo.routing.current={name:"home",url:damo.routing.home.url,oldUrl:damo.routing.home.url}),damo.method.buildRouting(),scope=$('damo-page[url="'+damo.routing.current.url+'"]'),damo.method.build(scope)}),$(window).on("hashchange",function(a){setTimeout(function(){var a=window.location.hash.replace(/^#!/,"");damoGo(a)},300)})}),damoRefresh=function(){$("[damo-loop]").length&&(damo.method.BuildLoops(),damo.method.SetDomValues(),damo.method.setConditions(),damo.method.setTriggers()),$("[damo-seed]").length&&(damo.method.BuildDirectives(),damo.method.SetDomValues(),fn=window[damo.routing[damo.routing.current.name].controller],"function"==typeof fn&&fn(),damo.method.setConditions(),damo.method.setTriggers());for(var a=0;a<2;a++)$("[damo-looping-start]").each(function(){damo.method.renewLoop($(this).attr("damo-looping-start"))});damo.method.SetDomValues(),damo.method.setConditions()},damoExport=function(){var a=new Date,b={id:"app",title:"Extract",description:"Data Model",date:a.toUTCString(),dataModel:damo.dm},c=document.createElement("a");c.href="data:attachment/text,"+encodeURI(JSON.stringify(b,null,4)),c.target="_blank",c.download="export.json",document.body.appendChild(c),c.click(),document.body.removeChild(c)};
