/*!
 * Damo JavaScript Library v0.0.1
 * http://www.oceanvirtuel.com/damo
 * Author Herve Le Cornec, hcl@oceanvirtuel.com
 * Copyright 2016 Herve Le Cornec
 * Released under the GPL license
 * http://www.gnu.org/licenses/gpl.html
 *
 * Requires jquery.js
 * Copyright 2005, 2016 jQuery Foundation, Inc. and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 *
 * Date: 2016-04-07T18:48Z
 */
var $scp={$route:{last:null,current:null,next:null},$routing:[],$filter:{},$directive:{},$config:{damperDelay:100,sliderDelay:200,iterationBreak:10,directiveDepth:3},$dm:{}};!function(){jQuery.each(["change"],function(e,t){jQuery.fn[t]=function(e,r){return e&&(str=e.toString().replace(/\n/g,"###kk###"),param=str.replace(/^function *\(([^\)]+)\) *\{.*$/i,"$1"),param==str?param=!1:param=param.replace(/###kk###/g,"\n"),func=str.replace(/^function[^\{]+\{/i,"").replace(/\} *$/g,"").replace(/###kk###/g,"\n"),str="\n				$scp.$element = $(this);				$.when(\n					$scp.$setObjProperty($scp.$dm,$(this))\n				).done(function() {\n				"+func+"					$scp.$updateView();\n				}).fail(function() {\n				"+func+"					$scp.$updateView();\n				})\n",e=param?new Function(param,"e",str):new Function("e",str)),arguments.length>0?this.on(t,null,e,r):this.trigger(t)}}),$scp.$setObjProperty=function(dm,elem){if(def=$.Deferred(),!dm||!elem)return def.resolve(),def.promise();tag=elem.prop("tagName").toLowerCase(),path=elem.attr("damo-id"),val=elem.val(),type=elem.prop("type"),checked=elem.prop("checked"),selected=elem.find(":selected").val(),"textarea"==tag&&(val=val.replace(/\n/,"\\n")),"select"==tag?val=selected:"checkbox"==type&&(val=checked);try{if(oldValue=eval("$scp."+path),"undefined"!=oldValue)return eval("$scp."+path+'="'+val+'";'),def.resolve(),def.promise()}catch(err){try{if(oldValue=eval("$scp.$dm."+path),"undefined"!=oldValue)return eval("$scp.$dm."+path+'="'+val+'";'),def.resolve(),def.promise()}catch(err){return def.resolve(),def.promise()}}},$scp.$buildDirectives=function(){def_directive=$.Deferred();var e,t,r=$("body");for(e in $scp.$directive)break;e||def_directive.resolve();for(e in $scp.$directive)items=r.find(e),items.length&&$.get($scp.$directive[e].template,function(r){for(i=0;i<items.length;i++)base=r,t=$(items[i]).attr("damo-seed")+".",reg=new RegExp($scp.$directive[e].seed+".","g"),base=base.replace(reg,t),$(items[i]).replaceWith(base)});return setTimeout(function(){def_directive.resolve()},$scp.$config.damperDelay),def_directive.promise()},$scp.$updateLoops=function(){var e,t,r,o,a,i,n,c,s,p;for(def_updateloop=$.Deferred(),r=$("body"),t=0;t<$scp.$config.directiveDepth;t++){var l=!1;r.find("[damo-startloop]").each(function(){if($(this).is(l))return l=$(this),!0;if(l=$(this),len=parseInt($(this).attr("damo-length")),tag=$(this).prop("tagName").toLowerCase(),elem=$(this),a=$(this).attr("damo-startloop"),n=a.replace(/^ *([^ ]+) *in.*$/,"$1"),i=a.replace(/^.*in *([^ ]+) *$/,"$1"),o=$(this).prop("outerHTML"),c=$scp.$seekData(!1,i),c?diff=c.length-len:diff=0,diff){if(diff>0){for(e=0;e<len;e++)elem=elem.next();for(e=0;e<diff;e++)p=new RegExp($scp.$rxFormat(n+"."),"g"),s=o.replace(p,i+"["+(len+e)+"]."),s=s.replace(/\[\[/g,"{{").replace(/\]\]/g,"}}"),elem.after(s),elem=elem.next(),elem.removeAttr("damo-startloop").removeAttr("damo-length").show()}else{for(diff=-diff,elem=$(this),e=0;e<len;e++)elem=elem.next();for(e=0;e<diff;e++)inter=elem.prev(),elem.remove(),elem=inter}$(this).attr("damo-length",c.length)}}).promise().done(function(){$scp.$setTriggers(),def_updateloop.resolve()})}return def_updateloop.promise()},$scp.$seekData=function(filter,param){var val;if(filter)try{if(val=eval("$scp.$filter."+filter+"($scp."+param+")"),!val||"undefined"===val)try{val=eval("$scp.$filter."+filter+"($scp.$dm."+param+")")}catch(err){}}catch(err){try{val=eval("$scp.$filter."+filter+"($scp.$dm."+param+")")}catch(err){}}else try{if(val=eval("$scp."+param),!val||"undefined"===val)try{val=eval("$scp.$dm."+param)}catch(err){}}catch(err){try{val=eval("$scp.$dm."+param)}catch(err){}}return val},$scp.$setDmValues=function(){return def=$.Deferred(),scope=$("body"),$("body").find("option").filter(':contains("{{")').length&&$("body").find("option").filter(':contains("{{")').each(function(){text=$(this).text().replace(/\n/g,""),reg=new RegExp("^.*{{ *([^}{ ]+) *}}.*$"),res=text.match(reg),res&&(val=$scp.$seekData(!1,res[1]),reg=new RegExp($scp.$rxFormat("{{ *"+res[1]+" *}}"),"g"),$(this).text($(this).text().replace(reg,val)),$(this).val(val))}),scope.find("[damo-id]").each(function(){tag=$(this).prop("tagName").toLowerCase(),type=$(this).prop("type")?$(this).prop("type").toLowerCase():!1,filter=$(this).attr("damo-filter"),val=$scp.$seekData(filter||null,$(this).attr("damo-id")),"object"!=typeof val&&"undefined"!=val&&(val=String(val),"select"==tag?"null"!=String($(this).val())?$(this).val(val):$(this).val($(this).find("option").first().val()):"input"==tag&&"radio"==type?$(this).val()==val&&($('[damo-id="'+$(this).attr("damo-id")+'"]').prop("checked",!1),$('[damo-id="'+$(this).attr("damo-id")+'"][value="'+val+'"]').prop("checked",!0)):"input"==tag&&"checkbox"==type?"true"==val||"1"==val?$(this).prop("checked",!0):("false"==val||"0"==val)&&$(this).prop("checked",!1):"input"==tag||"textarea"==tag?$(this).val(val):$(this).html(val))}).promise().done(function(){def.resolve()}),def.promise()},$scp.$setConditions=function(){var res,newcond,newconddm,def;return def=$.Deferred(),scope=$("body"),scope.find("[damo-if]").each(function(){var cond=$(this).attr("damo-if");reg=new RegExp(".*([<>&|!= ]).*","g");var a=cond.replace(/[!&<>=\|]/g," ").replace(/ +/g," ");arr=a.split(" "),newcond=cond,newconddm=cond;for(var i=0;i<arr.length;i++)""!==arr[i]&&(reg=new RegExp(arr[i].replace(/\[/g,"\\[").replace(/\]/g,"\\]")),newcond=newcond.replace(reg,"$scp."+arr[i]),newconddm=newconddm.replace(reg,"$scp.$dm."+arr[i]));res=!1;try{res=eval(newcond)}catch(err){try{res=eval(newconddm)}catch(err){}}res?$(this).slideDown($scp.$config.sliderDelay):$(this).slideUp($scp.$config.sliderDelay)}).promise().done(function(){def.resolve()}),def.promise()},$scp.$buildForms=function(){var key;return def=$.Deferred(),scope=$("body"),scope.find("[damo-submitform]").each(function(){$(this).click(function(){for(key in $scp.$dm)break;var arr=[];$('[damo-form="'+$(this).attr("damo-submitform")+'"]').find("input[id]:visible,select[id]:visible,textarea[id]:visible,[damo-id]:visible").each(function(){arr.push({item:$(this).attr("id")||$(this).attr("damo-id"),value:$(this).val()})}),$scp.$submitData=arr;try{eval("$scp."+$(this).attr("damo-submitform")+"()")}catch(err){}})}).promise().done(function(){$scp.$setTriggers().done(function(){def.resolve()})}),def.promise()},$scp.$setTriggers=function(){return def=new $.Deferred,scope.find("[damo-trigger]").each(function(){$(this).unbind("click"),$(this).click(function(e){try{eval("$scp."+$(this).attr("damo-trigger")+"(e)")}catch(err){}})}).promise().done(function(){def.resolve()}),def.promise()},$scp.$Damo=function(e,t){$(document).ready(function(){if(def_Damo=new $.Deferred,e){"string"==typeof e?$.get(e,function(e){return $scp.$dm=e,!0}):$scp.$dm=e;var r,o,a;if($scp.$afterLoading=t?t:function(){},$scp.$routing.length){for(o=!1,r=0;r<$scp.$routing.length;r++)if("index.html"===$scp.$routing[r].template){o=!0,0!==r&&(a=$scp.$routing[r],$scp.$routing.splice(r,1),$scp.$routing.unshift(a),$scp.$routing.sort());break}o||$scp.$routing.unshift({url:"/",template:"index.html"})}else page=window.location.href.replace(/.*\/([^\/]+)(\?.*)?/,"$1"),reg=new RegExp(".*/?([^/]+).html$","i"),page.match(reg)?$scp.$routing.push({url:"/",template:page}):$scp.$routing.push({url:"/",template:"index.html"});return $scp.$route.current=$scp.$routing[0].url,$('[damo-damo="'+$scp.$route.current+'"]').attr("damo-damo",""+$scp.$route.current),$scp.$concatenePages().done(function(){setTimeout(function(){$scp.$buildDirectives().done(function(){setTimeout(function(){$scp.$buildLoops().done(function(){setTimeout(function(){$scp.$setDmValues().done(function(){setTimeout(function(){$scp.$setConditions().done(function(){setTimeout(function(){$scp.$buildForms().done(function(){setTimeout(function(){$scp.$afterLoading(),setTimeout(function(){$("[damo-id]").change(function(){}),def_Damo.resolve()},$scp.$config.damperDelay)},$scp.$config.damperDelay)})},$scp.$config.damperDelay)})},$scp.$config.damperDelay)})},$scp.$config.damperDelay)})},$scp.$config.damperDelay)})},$scp.$config.damperDelay)}),def_Damo.promise()}})},$scp.$concatenePages=function(){var e;for(def_concat=new $.Deferred,cnt=0,e=1;e<$scp.$routing.length;e++)$("body").append('<div damo-damo="'+$scp.$routing[e].url+'"></div>'),$('[damo-damo="'+$scp.$routing[e].url+'"]').css("display","none"),$.get($scp.$routing[e].template,function(e){cnt++,cnt==$scp.$routing.length-1&&def_concat.resolve(),$('[damo-damo="'+$scp.$routing[cnt].url+'"]').html(e)}),setTimeout(function(){},$scp.$config.damperDelay);return 1==$scp.$routing.length&&def_concat.resolve(),def_concat.promise()},$scp.$buildLoops=function(){def_loop=$.Deferred();$("body");if($("[damo-loop]").length)for(k=0;$("[damo-loop]").length&&(N=$("[damo-loop]").length,n=1,$("[damo-loop]").each(function(){if(loop=$(this).attr("damo-loop"),listName=loop.replace(/.*in *([^ ]+) *$/,"$1"),varName=loop.replace(/^ *([^ ]+) *in.*$/,"$1"),list=$scp.$seekData(!1,listName),tag=$(this).prop("tagName"),template=$(this).prop("outerHTML"),template2=template.replace(/damo\-loop/,"damo-startloop").replace(/\{/g,"[").replace(/\}/g,"]"),list){for(tag.match(/option/i)?($(this).parent().before(template2),$(this).parent().prev().css("display","none").attr("damo-length",list.length)):($(this).before(template2),$(this).prev().css("display","none").attr("damo-length",list.length)),base=$(this).prop("outerHTML").replace(/\n/g,"##&#gh491#@@"),base=base.replace(/damo\-loop *= *\"[^\"]+\"/,""),total="",i=0;i<list.length;i++)str=base,reg=new RegExp($scp.$rxFormat(varName+"."),"g"),str=str.replace(reg,listName+"["+i+"]."),total+=str;total&&$(this).replaceWith(total.replace(/##&#gh491#@@/g,"\n"))}else tag.match(/option/i)?($(this).parent().before(template2),$(this).parent().prev().css("display","none").attr("damo-length",0)):($(this).before(template2),$(this).prev().css("display","none").attr("damo-length",0)),$(this).remove();$(this).remove(),n++,n>N&&def_loop.resolve()}),k++,!(k>$scp.$config.iterationBreak)););else def_loop.resolve();return def_loop.promise()},$scp.$updateView=function(){var e=$.Deferred();return setTimeout(function(){$.when($scp.$updateLoops()).done($scp.$setDmValues()).done($scp.$setConditions()).done(function(){e.resolve()})},$scp.$config.timeoutShort),e.promise()},$scp.$ArrayUnique=function(e,t,r){return r.indexOf(e)===t},$scp.$rxFormat=function(e){return e?e.replace(/\"/g,'\\"').replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\-/g,"\\-").replace(/\|/g,"\\|").replace(/\./g,"\\.").replace(/\{/g,"\\{").replace(/\}/g,"\\}"):e}}(),$(document).ready(function(){$(window).on("popstate",function(e){var t=String(window.location.href).replace(/.*#(.*)$/,"$1");$('[damo-damo="'+t+'"]').length&&($scp.$route.last=$scp.$route.current,$scp.$route.current=t,$('[damo-damo="'+$scp.$route.last+'"]').hide(),$scp.$updateView(),$('[damo-damo="'+$scp.$route.current+'"]').show())}),$scp.$changePage=function(e){var t=window.location.href.replace(/#.*$/,"");for(i=0;i<$scp.$routing.length;i++)if($scp.$routing[i].url===e){$('[damo-damo="'+e+'"]').length?(window.location.href=t+"#"+$scp.$routing[i].url,setTimeout(function(){$scp.$updateView()},$scp.$config.damperDelay),$('[damo-damo="'+$scp.$route.last+'"]').hide(),$('[damo-damo="'+$scp.$route.current+'"]').show()):(window.location.href=t+"#"+$scp.$routing[i].url,$("body").append('<div damo-damo="'+e+'"></div>'),$scp.$route.last=$scp.$route.current,$scp.$route.current=$scp.$routing[i].url,$('[damo-damo="'+$scp.$route.last+'"]').hide(),$('[damo-damo="'+$scp.$route.current+'"]').load($scp.$routing[i].template),$('[damo-damo="'+$scp.$route.current+'"]').show());break}}});
